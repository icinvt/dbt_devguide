### 3. モデルのベストプラクティス

#### モデルの設計指針

dbtプロジェクトでのモデル設計は、スケーラビリティ、再利用性、パフォーマンスの向上を重視する必要があります。本ガイドラインでは、以下の設計指針を採用することで、保守性の高いデータモデルを構築する方法を示します。

---

##### 1. **単一責任の原則**
- 各モデルは、特定の変換または目的を持つように設計します。一つのモデルが複数の役割を担うことは避け、データ処理のロジックを明確化します。
  - 例: ステージングモデルはデータのクレンジングと正規化に特化し、集計や複雑なロジックを含めない。

---

##### 2. **レイヤードアプローチ**
- モデルは以下の3つのレイヤーに分けて構築し、それぞれの役割を明確にします。
  1. **ステージングレイヤー**  
     - 生データを取得し、クリーニング、正規化、標準化を行います。
     - データソースごとに個別のサブディレクトリを作成し、モデルを整理します。
     - プレフィックス: `stg_`
  2. **中間レイヤー**  
     - 複数のステージングモデルを組み合わせて、新しい派生データセットを作成します。
     - ビジネスマート用のデータ準備やデータ統合を担います。
     - プレフィックス: `int_`
  3. **マートレイヤー**  
     - ビジネスニーズに特化したデータを提供する最終レイヤーです。
     - 事実テーブル（`fct_`）やディメンションテーブル（`dim_`）を構築します。

---

##### 3. **再利用性の確保**
- 再利用可能なロジックやパターンはマクロ化し、Jinjaテンプレートを活用します。
  - 例: サロゲートキー生成や非アクティブなレコードのフィルタリングなど、頻繁に使用するロジックをマクロとして抽象化します。

---

##### 4. **依存関係の最適化**
- モデル間の依存関係を最小限に抑え、必要なデータだけを取り込むようにします。これにより、クエリパフォーマンスが向上し、依存関係による障害のリスクが軽減されます。

---

##### 5. **命名規則の統一**
- モデル名とカラム名には、一貫性のある命名規則を適用します。モデル名にはレイヤーを示すプレフィックスを付け、カラム名は小文字とアンダースコアで記述します。
  - 例: `stg_orders`, `int_sales_summary`, `fct_revenue`

---

##### 6. **ドキュメント化**
- 各モデルには、対応するYAMLファイルで以下を記述します。
  - モデルの目的
  - 使用されているデータソース
  - 含まれるカラムとその意味
  - 適用されるテスト（ユニーク制約、非NULL制約など）

---

##### 7. **パフォーマンスの考慮**
- モデル設計時に、クエリパフォーマンスを考慮します。
  - 不要なJOINやサブクエリを避け、必要なカラムのみを選択する。
  - インデックスが効果的に利用されるよう、クエリ設計を最適化する。

---

##### 8. **継続的改善**
- モデルの使用状況やビジネスニーズに基づいて定期的にモデルを見直し、最適化を行います。使用されていないモデルやカラムは削除することで、プロジェクトの複雑性を軽減します。

---

この設計指針に従うことで、dbtプロジェクトのモデルが効率的かつ保守しやすい形で構築され、チーム全体の作業効率が向上します。